{{- if or (index .Values "istio-ingress" "enabled") (index .Values "istio-private-ingress" "enabled") }}
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ingressgateway-listener-tcp-keepalive
  namespace: {{ .Release.Namespace }}
  labels:
{{ include "kubezero-lib.labels" . | indent 4 }}
spec:
  configPatches:
  - applyTo: LISTENER
    patch:
      operation: MERGE
      value:
        socket_options:
          # SOL_SOCKET = 1
          # SO_KEEPALIVE = 9
        - int_value: 1
          level: 1
          name: 9
          state: STATE_PREBIND
          # TCP_KEEPPROBES
        - int_value: 9
          level: 6
          name: 6
          state: STATE_PREBIND
          # IPPROTO_TCP = 6
          # TCP_KEEPIDLE = 4
        - int_value: 120
          level: 6
          name: 4
          state: STATE_PREBIND
          # TCP_KEEPINTVL = 5
        - int_value: 30
          level: 6
          name: 5
          state: STATE_PREBIND
{{- end }}
