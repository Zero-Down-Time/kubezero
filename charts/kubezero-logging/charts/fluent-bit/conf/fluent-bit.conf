[SERVICE]
    Flush {{ .Values.config.flushInterval }}
    Daemon Off
    Log_Level {{ .Values.config.logLevel }}
    Parsers_File parsers.conf
    Parsers_File custom_parsers.conf
    HTTP_Server On
    HTTP_Listen 0.0.0.0
    HTTP_Port 2020

[INPUT]
    Name tail
    Path /var/log/containers/*.log
    Parser cri-log
    Tag cri.*
    Mem_Buf_Limit {{ .Values.config.input.memBufLimit }}
    Skip_Long_Lines On
    Refresh_Interval {{ .Values.config.input.refreshInterval }}
    DB /var/log/flb_kube.db
    DB.Sync Normal

[FILTER]
    Name    lua
    Match   cri.*
    script  /fluent-bit/etc/functions.lua
    call    reassemble_cri_logs

[FILTER]
    Name kubernetes
    Match cri.*
    Merge_Log On
    Merge_Log_Key kube
    Kube_Tag_Prefix cri.var.log.containers.
    Keep_Log Off
    K8S-Logging.Parser Off
    K8S-Logging.Exclude Off

{{- if index .Values "config" "extraRecords" }}

[FILTER]
    Name record_modifier
    Match cri.*
    {{- range $k,$v := index .Values "config" "extraRecords" }}
    Record {{ $k }} {{ $v }}
    {{- end }}
{{- end }}

[FILTER]
    Name rewrite_tag
    Match cri.*
    Emitter_Name kube_tag_rewriter
    Rule logtag F kube.$kubernetes['namespace_name'].$kubernetes['container_name'] false

[FILTER]
    Name    lua
    Match   kube.*
    script  /fluent-bit/etc/functions.lua
    call    nest_k8s_ns

{{- if .Values.config.outputs }}
{{ tpl .Values.config.outputs . }}
{{- else }}
[OUTPUT]
    Match *
    Name forward
    Host {{ .Values.config.output.host }}
    Port 24224
    Shared_Key {{ .Values.config.output.sharedKey }}
    tls {{ ternary "on" "off" .Values.config.output.tls }}
    Send_options true
    Require_ack_response true
{{- end }}
